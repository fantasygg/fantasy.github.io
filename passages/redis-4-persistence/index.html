<!DOCTYPE html>
<html lang="zh-CN">

  
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta name="author" content="è‘£æ²…é‘«, yuanxin.me@gmail.com">
  
  
  
  <title>Redisä»å…¥é—¨åˆ°ç²¾é€š(å››ã€Redisçš„æŒä¹…åŒ–å’Œæ•°æ®å¤‡ä»½ä¸æ¢å¤) | Wangkai&#39;s blog</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="Redisä»å…¥é—¨åˆ°ç²¾é€š,Redis,">
  

  <script>
    console.log('\n%c Hexo-theme-bmw v4.0 ' + '%c ğŸ‰ https://github.com/dongyuanxin/theme-bmw ğŸ‰\n' + '\n%c View demo online ' + '%c ğŸ” https://godbmw.com/ ğŸ”  \n' , 'color: #fadfa3; background: #030307; padding:3px 0;', '', 'color: #fadfa3; background: #030307; padding:3px 0;', '');
  </script>

  
    <meta name="description" content="Javaå¼€å‘">
  

  

  
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="/images/touch-icon.png">
  

  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/icon/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">

  <script src="/js/util.js"></script>
<script src="/js/valine.min.js"></script>

  

  
    <link href="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.js" async></script>
  

  
  
  <script src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js" async></script>
  
  

</head>

  <body>

    

    <div id="app">

      <div class="header-wrap">
  <header>
    <div class="site-brand">
      <div class="site-title">
        <a href="/">Fantasy</a>
      </div>
    </div>
    <nav class="site-navigation">
      <ul class="nav-menu">
      
        <li class="nav-item" data-path="/">
          
            <a href="/" target="_self">
              ä¸»é¡µ
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/archives/">
          
            <a href="/archives/" target="_self">
              å½’æ¡£
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/categories/">
          
            <a href="/categories/" target="_self">
              åˆ†ç±»
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/tags/">
          
            <a href="/tags/" target="_self">
              æ ‡ç­¾
            </a>
          
        </li>
      
        <li class="nav-item" data-path="https://github.com/fantasygg">
          
            <a href="https://github.com/fantasygg" target="_self">
              Github
            </a>
          
        </li>
      
      </ul>
    </nav>
    <i class="iconfont icon-menu"></i>
  </header>
</div>

<script>
  let links = document.querySelectorAll('.nav-item');
  for(let link of links){
    let childrenLink = link.querySelector('ul');
    link.addEventListener('mouseenter', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown active";
      }
    })
    link.addEventListener('mouseleave', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown";
      }
    })
  }
  let rootRealPath = getRealPath(window.location.pathname, true);
  for(let link of links) {
    let linkPath = link.getAttribute("data-path");
    if(linkPath && getRealPath(linkPath, true) === rootRealPath) {
      link.className = "nav-item hover";
    }
  }

  let iconMenu = document.querySelector("i.iconfont.icon-menu"),
    iconMenuClicked = false;
  let navDOM = document.querySelector("nav.site-navigation");
  iconMenu.addEventListener("click", () => {
    iconMenuClicked 
      ? navDOM.className = "site-navigation active"
      : navDOM.className = "site-navigation";
    iconMenuClicked = !iconMenuClicked;
  })
</script>

      








<div class="container post-index">

  

<div class="post">
  <h1 class="article-title">
    <span>Redisä»å…¥é—¨åˆ°ç²¾é€š(å››ã€Redisçš„æŒä¹…åŒ–å’Œæ•°æ®å¤‡ä»½ä¸æ¢å¤)</span>
  </h1>
  <div class="article-top-meta">
    <span>
      å‘å¸ƒ : 
      2019-05-04
    </span>
    
      <span>
        åˆ†ç±» : 
          <a href="/categories/Redisä»å…¥é—¨åˆ°ç²¾é€š/">
            Redisä»å…¥é—¨åˆ°ç²¾é€š
          </a>
      </span>
    
    
  </div>

  

  <div class="article-content">
    <div class="markdown-body">
      <p>Redisæä¾›äº†ä¸¤ç§æŒä¹…åŒ–çš„é€‰é¡¹,ä¸€ç§æ˜¯<strong>å¿«ç…§æ–‡ä»¶(snapshotting,RDB)</strong>,å®ƒä¼šåŸºäºæŸä¸ªæ—¶é—´ç‚¹å°†æ•°æ®å…¨éƒ¨å†™å…¥ç¡¬ç›˜ä¸­(é»˜è®¤ä¸º<code>dump.rdb</code>)ã€‚å¦ä¸€ç§æ˜¯<strong>åªè¿½åŠ æ–‡ä»¶(append-only,AOF)</strong>,å®ƒä¼šåœ¨æ‰§è¡Œå†™å…¥å‘½ä»¤æ—¶å°†å‘½ä»¤å†™å…¥åˆ°ç¡¬ç›˜ä¸­ã€‚</p>
<p>RedisæŒä¹…åŒ–æ•°æ®æœ€ä¸»è¦æ˜¯ä¸ºäº†<strong>æ•°æ®å¤‡ä»½,æ•…éšœæ¢å¤</strong>,ä¹Ÿæœ‰ä¸€äº›ç»è¿‡è€—æ—¶è¾ƒé•¿çš„è®¡ç®—ç»“æœå­˜åœ¨Redisä¸­,å¦‚æœè¿™äº›æ•°æ®å­˜åœ¨ç¡¬ç›˜ä¸­,å³ä½¿æœåŠ¡å™¨é‡å¯äº†ä¹‹å,è¿™äº›æ•°æ®è¿˜æ˜¯å­˜åœ¨çš„,ä¸ç”¨å†å»è€—æ—¶è®¡ç®—äº†ã€‚</p>
<p>è¿™ä¸¤ç§æ–¹å¼å¯ä»¥å•ç‹¬ä½¿ç”¨,ä¹Ÿå¯ä»¥ç»“åˆèµ·æ¥ä½¿ç”¨ã€‚æœ€é‡è¦çš„è¿˜æ˜¯è¦ç†è§£RDBå’ŒAOFçš„ä¼˜åŠ£åŠ¿ï¼Œç»“åˆè‡ªå·±çš„åº”ç”¨åšä¸€ä¸ªæƒè¡¡ã€‚</p>
<h2 id="RDB-SNAPSHOTTING"><a href="#RDB-SNAPSHOTTING" class="headerlink" title="RDB (SNAPSHOTTING)"></a>RDB (SNAPSHOTTING)</h2><h3 id="RDB-é…ç½®é¡¹"><a href="#RDB-é…ç½®é¡¹" class="headerlink" title="RDB é…ç½®é¡¹"></a>RDB é…ç½®é¡¹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">save 900 1</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir ./</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢6é¡¹é…ç½®ä¸­,å‰5é¡¹å‡æ˜¯<code>RDB</code>çš„é…ç½®,æœ€åä¸€ä¸ªæ˜¯<code>RDB</code> ä¸ <code>AOF</code> å…¬ç”¨çš„é…ç½®</p>
<ul>
<li><code>dir ./</code>,æŒ‡å®š <code>RDB</code> å’Œ <code>AOF</code> æ–‡ä»¶çš„è·¯å¾„</li>
<li><code>save 900 1</code> , å¤šä¹…æ‰§è¡Œä¸€æ¬¡å¿«ç…§æ“ä½œ, 900ç§’å†…æœ‰1æ¬¡å†™å…¥åˆ™æ‰§è¡Œå¿«ç…§æ“ä½œ</li>
<li><code>stop-writes-on-bgsave-error</code> , åˆ›å»ºå¿«ç…§å¤±è´¥åæ˜¯å¦ä¾ç„¶å†™å‘½ä»¤,é»˜è®¤ä¸º<code>yes</code></li>
<li><code>rdbcompression</code> , æ˜¯å¦å¯¹å¿«ç…§æ–‡ä»¶è¿›è¡Œå‹ç¼©,é»˜è®¤ä¸º <code>yes</code></li>
<li><code>rdbchecksum</code> , rdbæ–‡ä»¶æ˜¯å¦å¯ç”¨CRC64æ–‡ä»¶æ•°æ®å®Œæ•´æ€§æ£€æŸ¥,5.0ç‰ˆæœ¬ä¹‹åçš„å±æ€§,é»˜è®¤ä¸º <code>yes</code>,å¼€å¯ååœ¨ <code>save</code> å’Œ <code>load</code> æ—¶å°†è€—è´¹ <code>10%</code>çš„æ€§èƒ½,å¯ä»¥å…³é—­æ­¤é…ç½®æ¥æé«˜æ€§èƒ½</li>
<li><code>dbfilename</code> , rdbæ–‡ä»¶å,é»˜è®¤ä¸º <code>dump.rdb</code></li>
</ul>
<h3 id="RDB-è¯¦è§£"><a href="#RDB-è¯¦è§£" class="headerlink" title="RDB è¯¦è§£"></a>RDB è¯¦è§£</h3><p>Redis é€šè¿‡åˆ›å»ºå¿«ç…§çš„æ–¹å¼,è·å¾—å†…å­˜ä¸­æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®å‰¯æœ¬ã€‚Redisé‡å¯æ—¶å¯ä»¥ä» <code>RDB</code> æ–‡ä»¶ä¸Šæ¢å¤æ•°æ®ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠ <code>RDB</code> æ–‡ä»¶å¤‡ä»½åœ¨åˆ«çš„æœåŠ¡å™¨ä¸Šã€‚</p>
<p>æ ¹æ®ä¸Šè¿°çš„å‡ ä¸ªé…ç½®é¡¹,å¿«ç…§è¢«å†™å…¥ <code>dir</code> ç›®å½•ä¸‹çš„ <code>dbfilename</code> æ–‡ä»¶ä¸­ã€‚å¦‚æœåœ¨æ–°çš„å¿«ç…§æ–‡ä»¶åˆ›å»ºå®Œæˆä¹‹å‰,RedisæœåŠ¡å™¨å‘ç”Ÿäº†å®•æœº,é‚£è¿™æœŸé—´çš„æ•°æ®å°†ä¸¢å¤±ã€‚</p>
<p>Redisä¸­æœ‰ä¸¤ä¸ªå‘½ä»¤å¯ä»¥åˆ›å»ºå¿«ç…§æ–‡ä»¶, <code>SAVE</code> å’Œ <code>BGSAVE</code>ã€‚</p>
<ul>
<li>æ‰§è¡Œ <code>SAVE</code> å‘½ä»¤å,æœåŠ¡å™¨å°†ä¸ä¼šå†ç›¸åº”ä»»ä½•å‘½ä»¤,ç›´åˆ°å¿«ç…§æ–‡ä»¶å®Œæˆã€‚</li>
<li>æ‰§è¡Œ <code>BGSAVE</code> å‘½ä»¤å,Redisçˆ¶è¿›ç¨‹ä¼šè°ƒç”¨ <code>fork</code> æ¥åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹,ç”±å­è¿›ç¨‹å»è´Ÿè´£å¿«ç…§æ–‡ä»¶çš„å†™å…¥,çˆ¶è¿›ç¨‹åˆ™ç»§ç»­å¤„ç†å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ã€‚</li>
</ul>
<ol>
<li>å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥å‘æœåŠ¡å™¨å‘é€ <code>SAVE</code> æˆ–è€… <code>BGSAVE</code></li>
<li>å¦‚æœè®¾ç½®äº† <code>save</code> é…ç½®é¡¹,è¾¾åˆ°é…ç½®é¡¹çš„è¦æ±‚æ—¶,Redisä¼šè‡ªåŠ¨æ‰§è¡Œ <code>BGSAVE</code> å‘½ä»¤ã€‚è¯¥é…ç½®é¡¹å¯ä»¥è®¾ç½®å¤šç»„,å¦‚æœè®¾ç½®äº†å¤šç»„,åªè¦è¾¾åˆ°å…¶ä¸­ä¸€ç»„çš„è¦æ±‚,å°±ä¼šæ‰§è¡Œ<code>BGSAVE</code></li>
<li>Redisé€šè¿‡<code>SHUTDOWN</code> æŒ‡ä»¤,æˆ–è€…æ¥æ”¶åˆ°æ ‡å‡† <code>TERM</code> ä¿¡å·æ—¶,ä¼šæ‰§è¡Œ <code>SAVE</code> å‘½ä»¤,é˜»å¡æ‰€æœ‰å®¢æˆ·ç«¯,ç›´åˆ° <code>SAVE</code> å‘½ä»¤æ‰§è¡Œå®Œæˆå,å…³é—­æœåŠ¡å™¨</li>
<li>Redisé…ç½®äº†å¤åˆ¶é›†ä¹‹å,ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘æ¥ <code>SYNC</code> å‘½ä»¤,ä¸»æœåŠ¡å™¨ä¼šæ‰§è¡Œ <code>BGSAVE</code> å‘½ä»¤,ç„¶åå°†å¿«ç…§æ–‡ä»¶å‘ç»™ä»æœåŠ¡å™¨</li>
</ol>
<p>éœ€è¦æ³¨æ„çš„æ˜¯, æ‰§è¡Œ <code>BGSAVE</code> å‘½ä»¤å¯èƒ½ä¼šé€ æˆæœåŠ¡å™¨æš‚åœå‡ æ¯«ç§’æˆ–è€…å‡ ç§’,å…·ä½“æ—¶é•¿è¦æ ¹æ®æ•°æ®é‡çš„å¤§å°ä»¥åŠæœåŠ¡å™¨çš„é…ç½®æ¥çœ‹ã€‚åœ¨æ•°æ®é‡ç‰¹åˆ«å¤§,æœåŠ¡å™¨å†…å­˜åƒç´§çš„æƒ…å†µä¸‹,å¯èƒ½ä¼šé€ æˆé•¿æ—¶é—´çš„åœé¡¿,ç”šè‡³å®•æœºã€‚é€šå¸¸æƒ…å†µä¸‹, <code>BGSAVE</code> æ˜¯è¦æ¯” <code>SAVE</code> å¥½ä¸€äº›,å› ä¸ºä¸ä¼šå½±å“å®¢æˆ·ç«¯çš„è¯·æ±‚,ä¸è¿‡åœ¨æ•°æ®é‡å·¨å¤§çš„æƒ…å†µä¸‹, <code>BGSAVE</code> å¯èƒ½ä¼šæ¯” <code>SAVE</code> æŒ‡ä»¤è€—æ—¶æ›´é•¿ã€‚æ‰€ä»¥è¿˜æ˜¯è¦ç»“åˆå…·ä½“çš„æ•°æ®æƒ…å†µæ¥é€‰æ‹©ã€‚å¦‚æœå¯ä»¥æ¥å—æ•°æ®ä¸¢å¤±5åˆ†é’Ÿ,15åˆ†é’Ÿ,1å°æ—¶ç”šè‡³æ›´é•¿æ—¶é—´çš„æ•°æ®çš„è¯,ç”šè‡³å¯ä»¥å…³é—­è‡ªåŠ¨ä¿å­˜,ç”±å®¢æˆ·ç«¯å†³å®šä»€ä¹ˆæ—¶å€™æ¥æ‰§è¡Œå¿«ç…§å‰¯æœ¬çš„åˆ›å»ºã€‚</p>
<h3 id="RDB-ä¼˜ç‚¹"><a href="#RDB-ä¼˜ç‚¹" class="headerlink" title="RDB ä¼˜ç‚¹"></a>RDB ä¼˜ç‚¹</h3><ul>
<li>å†·å¤‡ä»½ï¼Œä¾‹å¦‚:å¯ä»¥è®¾ç½®æ¯ä¸ªå°æ—¶å½’æ¡£æ•°æ®é›†,å¹¶å¤‡ä»½è‡³å…¶ä»–æœåŠ¡å™¨,å‘ç”Ÿç¾éš¾æ—¶å¯ä»¥é€‰æ‹©æ¢å¤æ•°æ®é›†çš„ä¸åŒå‰¯æœ¬ã€‚</li>
<li>å¯¹ Redis çš„è¯»å†™å½±å“å°,æœ€å¤§é™åº¦çš„æé«˜äº†æ€§èƒ½ã€‚çˆ¶è¿›ç¨‹ä¼šforkä¸€ä¸ªå­è¿›ç¨‹åŒºåšæ•°æ®é›†çš„å½’æ¡£,ä¸ä¼šå½±å“çˆ¶è¿›ç¨‹çš„å·¥ä½œã€‚</li>
<li>åœ¨æ¢å¤æ•°æ®é›†æ—¶ï¼ŒRDBæ¯”AOFæ›´åŠ é«˜æ•ˆ</li>
</ul>
<h3 id="RDB-ç¼ºç‚¹"><a href="#RDB-ç¼ºç‚¹" class="headerlink" title="RDB ç¼ºç‚¹"></a>RDB ç¼ºç‚¹</h3><ul>
<li>åœ¨å‘ç”Ÿç¾éš¾çš„æ—¶å€™ï¼ŒRDBä¼šæ¯”AOFä¸¢å¤±çš„æ•°æ®å¤šã€‚å¯ä»¥é€šè¿‡è®¾ç½®æ¥æ›´æ”¹ä¿å­˜ç‚¹,ä¸€èˆ¬è®¾ç½®ä¸º5åˆ†é’Ÿã€‚</li>
<li>RDB æ¯æ¬¡åœ¨forkå­çº¿ç¨‹æ¥æ‰§è¡ŒRDBå¿«ç…§æ–‡ä»¶æ—¶,å¦‚æœæ•°æ®æ–‡ä»¶ç‰¹åˆ«å¤§ä¸”CPUæ€§èƒ½ä¸ä½³,å¯èƒ½é€ æˆæœåŠ¡æš‚åœå‡ æ¯«ç§’æˆ–è€…å‡ ç§’ã€‚</li>
</ul>
<h2 id="AOF-append-only"><a href="#AOF-append-only" class="headerlink" title="AOF (append-only)"></a>AOF (append-only)</h2><h3 id="AOF-é…ç½®é¡¹"><a href="#AOF-é…ç½®é¡¹" class="headerlink" title="AOF é…ç½®é¡¹"></a>AOF é…ç½®é¡¹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">appendonly no</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">aof-use-rdb-preamble yes</span><br></pre></td></tr></table></figure>
<ul>
<li><code>appendonly</code>,æ˜¯å¦å¼€å¯ AOF,é»˜è®¤ä¸º <code>no</code></li>
<li><code>appendfilename</code>, AOF æ–‡ä»¶å</li>
<li><code>appendfsync</code>  â‘   ,å¤šä¹…æ‰å°†å†™å…¥çš„å†…å®¹åŒæ­¥åˆ°ç¡¬ç›˜ä¸Š,æœ‰ <code>always</code>,<code>everysec</code>(é»˜è®¤),<code>no</code> ä¸‰ç§ã€‚ä¸‹é¢å¯¹æ¯”äº†ä¸‰ç§æ–¹å¼çš„æ€§èƒ½</li>
<li><code>no-appendfsync-on-rewrite</code> ,åœ¨é‡å†™æ—¶æ˜¯å¦æ‰§è¡Œ<code>fsync</code>æ“ä½œ,é»˜è®¤ä¸º <code>no</code></li>
<li><code>auto-aof-rewrite-percentage</code> â‘¡, å½“æ–‡ä»¶è¾¾åˆ°ä¸Šä¸€ä¸ªæ–‡ä»¶çš„å¤šå°‘ç™¾åˆ†æ¯”æ—¶è‡ªåŠ¨é‡å†™</li>
<li><code>auto-aof-rewrite-min-size</code> â‘¡,è‡ªåŠ¨é‡å†™çš„æœ€å°æ–‡ä»¶ä½“ç§¯</li>
<li><code>aof-load-truncated</code> â‘¢,AOFæ–‡ä»¶è¢«æˆªæ–­æ—¶æ˜¯å¦å¯åŠ¨,é»˜è®¤ä¸º <code>yes</code></li>
<li><code>aof-use-rdb-preamble</code> â‘£,æ˜¯å¦æ”¯æŒAOFå’ŒRDBæ··åˆä½¿ç”¨,é»˜è®¤ä¸º <code>yes</code></li>
</ul>
<p>(1) å…³äº <code>appendfsync</code> çš„è¯´æ˜</p>
<table>
<thead>
<tr>
<th>é€‰é¡¹</th>
<th>åŒæ­¥é¢‘ç‡</th>
</tr>
</thead>
<tbody>
<tr>
<td> always</td>
<td>æ¯æ¬¡æ‰§è¡Œå†™å…¥æ“ä½œéƒ½æ‰§è¡Œ<code>fsync</code>,è¿™å°†éå¸¸å½±å“æ€§èƒ½,ä¸¥é‡é™ä½Redisçš„åå</td>
</tr>
<tr>
<td> everysec</td>
<td>æ¯éš”1sæ‰§è¡Œä¸€æ¬¡ <code>fsync</code>,æ˜¾ç¤ºçš„å°†å¤šä¸ªå†™å…¥å‘½ä»¤åŒæ­¥åˆ°ç¡¬ç›˜,æ€§èƒ½éå¸¸å¥½,å¦‚æœä¸¢å¤±æ•°æ®ä¹Ÿåªæ˜¯ä¸¢å¤±1så†…çš„æ•°æ®</td>
</tr>
<tr>
<td> no</td>
<td>ä¸æ‰§è¡Œ <code>fsync</code> ,äº¤ç»™æ“ä½œç³»ç»Ÿå»å¤„ç†ã€‚ä¸€èˆ¬Linuxæ˜¯æ¯éš”30såˆ·æ–°ä¸€æ¬¡æ•°æ®åˆ°ç£ç›˜ä¸Š,å–å†³äºå†…æ ¸çš„ç²¾å‡†è°ƒæ•´</td>
</tr>
</tbody>
</table>
<p>(2) å…³äº <code>rewrite</code></p>
<p>å‰é¢æåˆ°,AOFæ˜¯å°†æ¯æ¡å†™å…¥å‘½ä»¤éƒ½åŒæ­¥åˆ°ç¡¬ç›˜,åŒ…æ‹¬åˆ é™¤keyçš„æŒ‡ä»¤,ä¸€ç›´è¿™ä¹ˆä¸‹å»,AOFæ–‡ä»¶å°†ä¼šå˜çš„éå¸¸åºå¤§,ç”šè‡³å ç”¨æ‰€æœ‰ç¡¬ç›˜ç©ºé—´ã€‚</p>
<p><code>rewrite</code> å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„,å®ƒå¯¹åº”çš„å‘½ä»¤æ˜¯ <code>BGREWRITEAOF</code> , è¿™ä¸ªå‘½ä»¤å’Œ <code>BGSAVE</code> éå¸¸ç›¸ä¼¼,éƒ½æ˜¯ç”±Redisçˆ¶è¿›ç¨‹forkçš„å­è¿›ç¨‹å»æ‰§è¡Œæ“ä½œ,æ‰€ä»¥å®ƒå’Œ <code>BGSAVE</code> æœ‰ç›¸åŒçš„ç¼ºç‚¹ã€‚<br><code>BGREWRITEAOF</code> ä¼šé€šè¿‡ç§»é™¤AOFä¸­å†—ä½™å‘½ä»¤çš„æ–¹å¼æ¥é‡å†™AOFæ–‡ä»¶,é‡å†™ä¹‹åä½“ç§¯å°±ä¼šå˜å°å¾ˆå¤šã€‚</p>
<p><code>auto-aof-rewrite-percentage</code> å’Œ <code>auto-aof-rewrite-min-size</code> è¿™ä¸¤é¡¹é…ç½®æ˜¯é…ç½®è‡ªåŠ¨é‡å†™AOFæ–‡ä»¶çš„è§¦å‘æ¡ä»¶,åªæœ‰åœ¨è®¾ç½®äº† <code>appendonly yes</code> çš„æƒ…å†µä¸‹,ä¹Ÿå°±æ˜¯å¼€å¯äº†AOFæŒä¹…åŒ–æœºåˆ¶æ‰ä¼šç”Ÿæ•ˆã€‚<br>ä¸¾ä¸ªä¾‹å­,<code>auto-aof-rewrite-percentage 100</code>,  <code>auto-aof-rewrite-min-size 64mb</code> è¡¨ç¤º,å½“AOFå¤§äº <code>64mb</code> å¹¶ä¸”æ¯”ä¸Šä¸€æ¬¡é‡å†™ä¹‹åçš„ä½“ç§¯å¤§äº†<code>100%</code> æ‰ä¼šæ‰§è¡Œ<code>BGREWRITEAOF</code>ã€‚å¯ä»¥é€šè¿‡ä¿®æ”¹è¿™ä¸¤é¡¹å‚æ•°æ¥æ§åˆ¶AOFé‡å†™çš„é¢‘ç‡ã€‚</p>
<p>(3) å…³äº <code>aof-load-truncated</code></p>
<p>åœ¨å†™å…¥AOFæ–‡ä»¶çš„è¿‡ç¨‹ä¸­,å¯èƒ½ä¼šç”±äºå„ç§åŸå› (åœç”µ,ç£ç›˜ç©ºé—´å æ»¡,æœåŠ¡å™¨æ•…éšœå¯¼è‡´Rediså®•æœº)å¯¼è‡´AOFå†™å…¥å‘½ä»¤è¢«æˆªæ–­,å¦‚æœè¯¥é…ç½®é¡¹è®¾ç½®ä¸º <code>yes</code> , Rediså°†ä¼šåœ¨é‡å¯æ—¶,æ¸…é™¤è¢«æˆªæ–­çš„å‘½ä»¤ä¹‹åçš„æ‰€æœ‰å‘½ä»¤(é€šå¸¸æƒ…å†µä¸‹åé¢ä¹Ÿæ²¡æœ‰å‘½ä»¤äº†),ç„¶åæ­£å¸¸é‡å¯ã€‚å¦‚æœä¸æƒ³è¿™æ ·,å¯ä»¥å°†æ­¤é¡¹è®¾ç½®ä¸º <code>no</code> ,Rediså°†ä¼šåœ¨é‡å¯æ—¶æŠ›å‡ºé”™è¯¯å¹¶é€€å‡ºã€‚<strong>éœ€è¦æ³¨æ„çš„æ˜¯</strong>:æœ€æ–°ç‰ˆæœ¬ä¸­å³ä½¿è®¾ç½®äº† <code>no</code> , Redisä¹Ÿä¼šå°†è¢«æˆªæ–­çš„å‘½ä»¤ä¹‹åæ‰€æœ‰å‘½ä»¤åˆ é™¤,ä»¥ä¿è¯ä¸‹æ¬¡é‡æ–°å¯åŠ¨æ—¶èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨,è€ç‰ˆæœ¬ä¸­åˆ™ä¸ä¼š,éœ€è¦ä½¿ç”¨ <code>redis-check-aof</code> å·¥å…·æ¥ä¿®å¤,å…·ä½“å‘½ä»¤æ˜¯<code>redis-check-aof --fix</code></p>
<p>ä»¥ä¸‹æ˜¯<code>aof-load-truncated yes</code>çš„æƒ…å†µä¸‹,Redisé‡å¯æ—¶å‘ç°äº†AOFè¢«æˆªæ–­,æ‰“å‡ºçš„æ—¥å¿—</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* Reading RDB preamble from AOF file...</span><br><span class="line">* Reading the remaining AOF tail...</span><br><span class="line"># !!! Warning: short read while loading the AOF file !!!</span><br><span class="line"># !!! Truncating the AOF at offset 439 !!!</span><br><span class="line"># AOF loaded anyway because aof-load-truncated is enabled</span><br></pre></td></tr></table></figure>
<p>(4) å…³äº <code>aof-use-rdb-preamble</code></p>
<p>Redis4.0ä»¥åï¼Œæ”¯æŒAOFå’ŒRDBæ··åˆä½¿ç”¨,å¯ä»¥é€šè¿‡æ­¤é¡¹è¿›è¡Œé…ç½®æ˜¯å¦å¼€å¯ã€‚</p>
<h3 id="AOF-è¯¦è§£"><a href="#AOF-è¯¦è§£" class="headerlink" title="AOF è¯¦è§£"></a>AOF è¯¦è§£</h3><p>AOFæœºåˆ¶å¯¹æ¯æ¡å†™å…¥å‘½ä»¤ä½œä¸ºæ—¥å¿—ï¼Œä»¥append-onlyçš„æ¨¡å¼å†™å…¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œåœ¨redisé‡å¯çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡å›æ”¾AOFæ—¥å¿—ä¸­çš„å†™å…¥æŒ‡ä»¤æ¥é‡æ–°æ„å»ºæ•´ä¸ªæ•°æ®é›†ã€‚<br>Rediså¹¶ä¸ä¼šå°†æ•°æ®ç›´æ¥å†™å…¥ç¡¬ç›˜ä¸­,è€Œæ˜¯ä¼šå…ˆå°†æ•°æ®å†™è¿›<code>linux os cache</code>,ç„¶ååœ¨é€šè¿‡é…ç½®çš„<code>appendfsync</code> è®¾ç½®çš„æ—¶é—´æ¥æ‰§è¡Œ<code>fsync</code>æ“ä½œï¼Œå¼ºè¡Œå°†æ•°æ®åˆ·å…¥ç£ç›˜æ–‡ä»¶ã€‚<br>AOFæ˜¯å­˜æ”¾æ¯æ¡çš„å†™å‘½ä»¤,æ‰€ä»¥ä¼šä¸æ–­æ‰©å¤§,å½“å¤§åˆ°ä¸€å®šç¨‹åº¦,AOFåš<code>rewrite</code>æ“ä½œ,å°±ä¼šåŸºäºå½“æ—¶rediså†…å­˜ä¸­çš„æ•°æ®,æ¥é‡æ–°æ„é€ ä¸€ä¸ªæ›´å°çš„AOFæ–‡ä»¶,ç„¶åå°†æ—§çš„æ–‡ä»¶åˆ æ‰ã€‚</p>
<h3 id="AOF-ä¼˜ç‚¹"><a href="#AOF-ä¼˜ç‚¹" class="headerlink" title="AOF ä¼˜ç‚¹"></a>AOF ä¼˜ç‚¹</h3><ul>
<li>AOFå¯ä»¥æ›´å¥½çš„ä¿æŠ¤æ•°æ®ä¸ä¸¢å¤±,ä¸€èˆ¬AOFæ¯éš”ä¸€ç§’,é€šè¿‡åå°çº¿ç¨‹æ‰§è¡Œä¸€æ¬¡fsync,æœ€å¤šä¸¢å¤±1sçš„æ•°æ®ã€‚å¯ä»¥é€šè¿‡è®¾ç½®æ”¹ä¸ºæ¯æ¬¡å†™å…¥æ•°æ®æ—¶éƒ½æ‰§è¡Œfsyncï¼Œä¸è¿‡è¿™éå¸¸å½±å“æ€§èƒ½ã€‚</li>
<li>AOFæ—¥å¿—ä»…ä»…æ—¶é™„åŠ æ—¥å¿—ï¼Œå¦‚æœå› ä¸ºæŸäº›åŸå› å¯¼è‡´åªå†™å…¥ä¸€èˆ¬ï¼Œä¹Ÿå¯ä»¥é€šè¿‡<code>redis-check-aof</code> è½»æ¾ä¿®å¤ã€‚</li>
<li>AOFæ—¥å¿—æ–‡ä»¶è¿‡å¤§æ—¶,ä¼šåœ¨åå°æ‰§è¡Œrewriteæ“ä½œ,ä¸ä¼šå½±å“å®¢æˆ·ç«¯çš„è¯»å†™</li>
<li>AOFæ—¥å¿—æ–‡ä»¶å¯èƒ½æ€§å¥½ï¼Œå› ä¸ºè®°å½•çš„æ—¶ä¸€æ¡ä¸€æ¡çš„æŒ‡ä»¤ã€‚</li>
</ul>
<h3 id="AOF-ç¼ºç‚¹"><a href="#AOF-ç¼ºç‚¹" class="headerlink" title="AOF ç¼ºç‚¹"></a>AOF ç¼ºç‚¹</h3><ul>
<li>AOFæ—¥å¿—é€šå¸¸æ¯”RDBæ•°æ®å¿«ç…§æ–‡ä»¶æ›´å¤§</li>
<li>åšæ•°æ®æ¢å¤çš„æ—¶å€™å¯èƒ½ä¼šæ¯”RDBæ…¢</li>
<li>åšå®šæœŸçš„å†·å¤‡æ²¡æœ‰RDBæ–¹ä¾¿</li>
</ul>
<h2 id="RDBå’ŒAOFæ–‡ä»¶æŸåäº†"><a href="#RDBå’ŒAOFæ–‡ä»¶æŸåäº†" class="headerlink" title="RDBå’ŒAOFæ–‡ä»¶æŸåäº†"></a>RDBå’ŒAOFæ–‡ä»¶æŸåäº†</h2><p>Redisä¸ºæˆ‘ä»¬æä¾›äº†å·¥å…·,<code>redis-check-rdb</code> å’Œ <code>redis-check-aof</code></p>
<p>å…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@iZnom30el3gvhxZ ~]# redis-check-aof</span><br><span class="line">Usage: redis-check-aof [--fix] &lt;file.aof&gt;</span><br><span class="line">[root@iZnom30el3gvhxZ ~]# redis-check-rdb</span><br><span class="line">Usage: redis-check-rdb &lt;rdb-file-name&gt;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯å®˜æ–¹æ–‡æ¡£ä¸­å¯¹äºAOFæ–‡ä»¶æŸåçš„ä¸€äº›è¯´æ˜ï¼Œæˆ‘æ‘˜äº†è¿‡æ¥:</p>
<blockquote>
<p>If the AOF file is not just truncated, but corrupted with invalid byte sequences in the middle, things are more complex. Redis will complain at startup and will abort:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;* Reading the remaining AOF tail...</span><br><span class="line">&gt;# Bad file format reading the append only file: make a backup of your AOF file, then use ./redis-check-aof --fix &lt;filename&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>The best thing to do is to run the <code>redis-check-aof</code> utility, initially without the <code>--fix</code> option, then understand the problem, jump at the given offset in the file, and see if it is possible to manually repair the file: the AOF uses the same format of the Redis protocol and is quite simple to fix manually. Otherwise it is possible to let the utility fix the file for us, but in that case all the AOF portion from the invalid part to the end of the file may be discareded, leading to a massive amount of data lost if the corruption happen to be in the initial part of the file.</p>
<h3 id="How-it-works"><a href="#How-it-works" class="headerlink" title="How it works"></a>How it works</h3><p>Log rewriting uses the same copy-on-write trick already in use for snapshotting. This is how it works:</p>
<ul>
<li>Redis <a href="http://linux.die.net/man/2/fork" target="_blank" rel="noopener">forks</a>, so now we have a child and a parent process.</li>
<li>The child starts writing the new AOF in a temporary file.</li>
<li>The parent accumulates all the new changes in an in-memory buffer (but at the same time it writes the new changes in the old append-only file, so if the rewriting fails, we are safe).</li>
<li>When the child is done rewriting the file, the parent gets a signal, and appends the in-memory buffer at the end of the file generated by the child.</li>
<li>Profit! Now Redis atomically renames the old file into the new one, and starts appending new data into the new file.</li>
</ul>
<h3 id="How-I-can-switch-to-AOF-if-Iâ€™m-currently-using-dump-rdb-snapshots"><a href="#How-I-can-switch-to-AOF-if-Iâ€™m-currently-using-dump-rdb-snapshots" class="headerlink" title="How I can switch to AOF, if Iâ€™m currently using dump.rdb snapshots?"></a>How I can switch to AOF, if Iâ€™m currently using dump.rdb snapshots?</h3><p>There is a different procedure to do this in Redis 2.0 and Redis 2.2, as you can guess itâ€™s simpler in Redis 2.2 and does not require a restart at all.</p>
<p><strong>Redis &gt;= 2.2</strong></p>
<ul>
<li>Make a backup of your latest dump.rdb file.</li>
<li>Transfer this backup into a safe place.</li>
<li>Issue the following two commands:</li>
<li>redis-cli config set appendonly yes</li>
<li>redis-cli config set save â€œâ€</li>
<li>Make sure that your database contains the same number of keys it contained.</li>
<li>Make sure that writes are appended to the append only file correctly.</li>
</ul>
<p>The first CONFIG command enables the Append Only File. In order to do so <strong>Redis will block</strong> to generate the initial dump, then will open the file for writing, and will start appending all the next write queries.</p>
<p>The second CONFIG command is used to turn off snapshotting persistence. This is optional, if you wish you can take both the persistence methods enabled.</p>
<p><strong>IMPORTANT:</strong> remember to edit your redis.conf to turn on the AOF, otherwise when you restart the server the configuration changes will be lost and the server will start again with the old configuration.</p>
<p><strong>Redis 2.0</strong></p>
<ul>
<li>Make a backup of your latest dump.rdb file.</li>
<li>Transfer this backup into a safe place.</li>
<li>Stop all the writes against the database!</li>
<li>Issue a redis-cli bgrewriteaof. This will create the append only file.</li>
<li>Stop the server when Redis finished generating the AOF dump.</li>
<li>Edit redis.conf end enable append only file persistence.</li>
<li>Restart the server.</li>
<li>Make sure that your database contains the same number of keys it contained.</li>
<li>Make sure that writes are appended to the append only file correctly.</li>
</ul>
</blockquote>
<h2 id="RDBå’ŒAOFå¦‚ä½•é€‰æ‹©"><a href="#RDBå’ŒAOFå¦‚ä½•é€‰æ‹©" class="headerlink" title="RDBå’ŒAOFå¦‚ä½•é€‰æ‹©?"></a>RDBå’ŒAOFå¦‚ä½•é€‰æ‹©?</h2><p>é€šè¿‡ä»¥ä¸Šå†…å®¹,åº”è¯¥å·²ç»å¯¹RDBå’ŒAOFä¸¤ç§æ–¹å¼çš„ä¼˜ç¼ºç‚¹æœ‰äº†å¤§æ¦‚çš„äº†è§£,å…·ä½“å¦‚ä½•é€‰æ‹©,è¿˜éœ€æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡æƒ…å†µæ¥é€‰æ‹©,è¿™é‡Œç»™å‡ºçš„æ„è§æ˜¯ä¸¤ç§ä¸€èµ·ç”¨,æ¡ä»¶å…è®¸çš„è¯,å°†æŒä¹…åŒ–çš„æ–‡ä»¶æ—¶å¸¸å¤‡ä»½åˆ°å¤šå°ä¸åŒçš„æœåŠ¡å™¨ä¸Šã€‚</p>
<p>Redis4.0ä»¥åï¼Œæ”¯æŒAOFå’ŒRDBæ··åˆä½¿ç”¨,åœ¨ <code>redis.conf</code> ä¸­é€šè¿‡ <code>aof-use-rdb-preamble yes</code> è®¾ç½®ã€‚</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>ä»¥ä¸‹æ˜¯Rediså®˜æ–¹æ–‡æ¡£ä¸­å…³äº <strong>æ•°æ®å¤‡ä»½</strong> å’Œ <strong>ç¾éš¾æ¢å¤</strong> çš„è¯´æ˜,æˆ‘åšäº†ä¸€ä¸‹ç¿»è¯‘,å®˜æ–¹ç»™å‡ºçš„æ–¹æ¡ˆå·²ç»å¾ˆå®Œå–„äº†,å¯ä»¥å‚è€ƒä»¥ä¸‹,ç»“åˆè‡ªå·±çš„å®é™…æƒ…å†µå®æ–½</p>
<h3 id="æ•°æ®å¤‡ä»½"><a href="#æ•°æ®å¤‡ä»½" class="headerlink" title="æ•°æ®å¤‡ä»½"></a>æ•°æ®å¤‡ä»½</h3><blockquote>
<p>åœ¨å¼€å§‹æœ¬èŠ‚ä¹‹å‰,ç¡®ä¿è¯»äº†ä»¥ä¸‹å¥å­ï¼š<strong>å¯¹ä½ çš„æ•°æ®åº“åšå¤‡ä»½</strong>ã€‚ç£ç›˜æŸå,äº‘å®ä¾‹æ¶ˆå¤±ç­‰ç­‰:æ²¡æœ‰å¤‡ä»½æ„å‘³ç€å°†æ•°æ®ä¸¢å¤±åˆ° /dev/null</p>
<p>Rediså¯¹äºæ•°æ®å¤‡ä»½éå¸¸å‹å¥½,å› ä¸ºä½ å¯ä»¥åœ¨æ•°æ®åº“è¿è¡Œæ—¶æ‹·è´RDBæ–‡ä»¶: RDBæ–‡ä»¶ä¸€æ—¦ç”Ÿæˆå°±ä¸ä¼šæ”¹å˜,å®ƒåœ¨ç”Ÿæˆæ—¶ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶çš„åå­—,å½“æ–°çš„å¿«ç…§æ–‡ä»¶å®Œæˆä¹‹åä¼šä»¥åŸå­çš„æ–¹å¼ <code>rename</code> ç¡®ä¿æ›¿æ¢æ‰æ—§çš„å¿«ç…§æ–‡ä»¶ã€‚</p>
<p>è¿™æ„å‘³ç€å½“æ•°æ®åº“æ­£åœ¨è¿è¡Œæ—¶æ‹·è´RDBæ–‡ä»¶æ˜¯å®‰å…¨çš„ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬çš„å»ºè®®:</p>
<ul>
<li>åœ¨æœåŠ¡å™¨ä¸­åˆ›å»ºä¸€ä¸ª <code>cron</code> ä½œä¸š,åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­æ¯éš”ä¸€ä¸ªå°æ—¶åˆ›å»ºä¸€æ¬¡å¿«ç…§çš„å‰¯æœ¬,åœ¨å¦ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­æ¯éš”ä¸€å¤©åˆ›å»ºä¸€æ¬¡å¿«ç…§çš„å‰¯æœ¬ã€‚</li>
<li>æ¯æ¬¡è¿è¡Œ <code>cron</code> ä½œä¸šçš„è„šæœ¬æ—¶,ç¡®ä¿è°ƒç”¨ä¸€æ¬¡ <code>find</code> å‘½ä»¤æ¥ç¡®ä¿åˆ é™¤å¤ªæ—§çš„å¿«ç…§å‰¯æœ¬: ä¾‹å¦‚,ä½ å¯ä»¥ä¿ç•™æœ€è¿‘48å°æ—¶çš„æ¯å°æ—¶å¿«ç…§å‰¯æœ¬å’Œä¸€ä¸¤ä¸ªæœˆå†…çš„æ¯æ—¥å¿«ç…§å‰¯æœ¬ã€‚ç¡®ä¿ä½¿ç”¨æ•°æ®å’Œæ—¶é—´ä¿¡æ¯å‘½åå¿«ç…§å‰¯æœ¬ã€‚</li>
<li>æ¯å¤©è‡³å°‘ä¸€æ¬¡æŠŠè¿™äº›RDBå¿«ç…§å¤‡ä»½åˆ° <strong>æ•°æ®ä¸­å¿ƒä¹‹å¤–</strong> æˆ–è€… è‡³å°‘æ˜¯è¿è¡Œç€Rediså®ä¾‹çš„<strong>ç‰©ç†æœº</strong>ä¹‹å¤–ã€‚</li>
</ul>
<p>å¦‚æœRedisåªå¼€å¯äº†AOFçš„æŒä¹…åŒ–æ¨¡å¼,ä¹Ÿä»ç„¶å¯ä»¥åˆ›å»ºAOFæ–‡ä»¶çš„å¤‡ä»½ã€‚è¯¥æ–‡ä»¶å¯èƒ½ç¼ºå°‘æœ€åéƒ¨åˆ†,ä½†æ˜¯Redisä»ç„¶å¯ä»¥åŠ è½½å®ƒ(å‚è€ƒAOFæ–‡ä»¶è¢«æˆªæ–­ç›¸å…³å†…å®¹)ã€‚</p>
</blockquote>
<h3 id="ç¾éš¾æ¢å¤"><a href="#ç¾éš¾æ¢å¤" class="headerlink" title="ç¾éš¾æ¢å¤"></a>ç¾éš¾æ¢å¤</h3><blockquote>
<p>Redisçš„ç¾éš¾æ¢å¤å’Œå¤‡ä»½åŸºæœ¬ç›¸åŒ,è€Œä¸”å¯ä»¥ä¼ è¾“åˆ°è®¸å¤šä¸åŒçš„æ•°æ®ä¸­å¿ƒã€‚ä»¥è¿™ç§æ–¹å¼ä¿æŠ¤æ•°æ®,å³ä½¿åœ¨æ­£è¿è¡Œç€Redisçš„å®ä¾‹çš„ä¸»æ•°æ®ä¸­å¿ƒå‘ç”Ÿäº†ç¾éš¾æ€§äº‹ä»¶,è¿™äº›å¤‡ä»½çš„æ•°æ®ä¹Ÿå¾ˆå®‰å…¨ã€‚</p>
<p>ç”±äºè®¸å¤šRedisç”¨æˆ·æ­£å¤„äºèµ·å§‹é˜¶æ®µ,å¯èƒ½æ²¡æœ‰è¶³å¤Ÿçš„èµ„é‡‘å»æ‰§è¡Œä¸Šè¿°æ–¹æ¡ˆã€‚æˆ‘ä»¬å°†ä»‹ç»æœ€æœ‰è¶£çš„ç¾éš¾æ¢å¤æ–¹æ¡ˆ,è¿™äº›æŠ€æœ¯æˆæœ¬ä¸ä¼šå¾ˆé«˜ã€‚</p>
<ul>
<li>äºšé©¬é€ŠS3å’Œå…¶ä»–äº‘æ˜¯å®ç°ä½ çš„ç¾éš¾æ¢å¤ç³»ç»Ÿçš„ä¸€ä¸ªå¥½æ–¹æ¡ˆã€‚ç”¨åŠ å¯†çš„æ–¹å¼æŠŠä½ çš„æ¯æ—¥å’Œæ¯å°æ—¶çš„æ•°æ®å¿«ç…§ä¼ è¾“åˆ°S3ã€‚ä½ å¯ä»¥ç”¨<code>gpg -c</code>(å¯¹ç§°åŠ å¯†)åŠ å¯†ä½ çš„æ•°æ®ã€‚ä¿è¯æŠŠä½ çš„å¯†ç ä¿å­˜åœ¨å…¶ä»–å®‰å…¨çš„åœ°æ–¹(æ¯”å¦‚ç»™ä½ çš„ç»„ç»‡ä¸­æœ€é‡è¦çš„äººä¸€ä¸ªå‰¯æœ¬)ã€‚æ¨èä½ ä½¿ç”¨å¤šä¸ªæ•°æ®å­˜å‚¨æœåŠ¡æ¥æå‡ä½ çš„æ•°æ®å®‰å…¨æ€§ã€‚</li>
<li>ç”¨SCP(SSHçš„ä¸€éƒ¨åˆ†)å°†ä½ çš„å¿«ç…§ä¼ åˆ°å…¶ä»–è¿œç¨‹æœåŠ¡å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªç›¸å½“ç®€å•å’Œå®‰å…¨çš„æ–¹å¼: åœ¨ç¦»ä½ å¾ˆè¿œçš„åœ°æ–¹è·å–ä¸€ä¸ªVPS,åœ¨é‚£é‡Œå®‰è£…SSH,å¹¶ç”Ÿæˆä¸€ä¸ªæ²¡æœ‰å¯†ç çš„sshå®¢æˆ·ç«¯,ç„¶åæŠŠå®ƒæ·»åŠ åˆ°VPSçš„ <code>authorized_keys</code> æ–‡ä»¶ä¸­ã€‚ä½ å·²ç»å‡†å¤‡å¥½äº†ä»¥è‡ªåŠ¨çš„æ–¹å¼ä¼ è¾“è¿™äº›å¤‡ä»½æ–‡ä»¶ã€‚è‡³å°‘ä»ä¸¤ä¸ªä¸åŒçš„VPSæä¾›å•†è·å–VPS,ä»¥ä¿è¯æœ€å¥½çš„ç»“æœã€‚</li>
</ul>
<p>æœ€é‡è¦çš„æ˜¯ç†è§£,å¦‚æœä½ æ²¡æœ‰ä»¥æ­£ç¡®çš„æ–¹å¼å»å®ç°ä¸Šè¿°æ–¹æ¡ˆã€‚è‡³å°‘ç»å¯¹ç¡®ä¿åœ¨ä¼ è¾“å®Œæˆä¹‹åæ£€æŸ¥æ–‡ä»¶çš„å¤§å°(å®ƒåº”è¯¥è¦å’Œä½ å¤åˆ¶çš„æ–‡ä»¶å¤§å°ä¸€è‡´),å¦‚æœä½ ä½¿ç”¨VPSçš„è¯,è¿˜è¦éªŒè¯SHA1æ‘˜è¦ã€‚</p>
<p>å¦‚æœå¤‡ä»½åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ç”±äºæŸäº›åŸå› å¤±è´¥äº†,ä½ ä¹Ÿéœ€è¦ä¸€å¥—ç‹¬ç«‹çš„è­¦æŠ¥ç³»ç»Ÿã€‚</p>
</blockquote>
<hr>
<p>æ›´å¤šè¯¦ç»†å†…å®¹å‚è€ƒ:</p>
<p><a href="https://redis.io/topics/persistence" target="_blank" rel="noopener">RedisæŒä¹…åŒ–å®˜æ–¹æ–‡æ¡£</a></p>
<p><a href="http://redisinaction.com/" target="_blank" rel="noopener">Rediså®æˆ˜</a></p>
    </div>
  </div>
  
    <div class="copy-right">
      <div class="markdown-body">
        <blockquote>
        
        
          æœ¬æ–‡ä½œè€… : Wang Kai <br>
        
        åŸæ–‡é“¾æ¥ : <a href>https://blog.fantasywk.tech/passages/redis-4-persistence/</a><br>
        ç‰ˆæƒå£°æ˜ : æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
        </blockquote>
      </div>
    </div>
  
  
  

  

  <div class="article-footer">
    <div class="article-meta pull-left">
      <span>
        
          <i class="iconfont icon-06tags"></i>æ ‡ç­¾: 
          
          <span class="span--tag">
            <a href="/tags/Redis/">
              #Redis
            </a>
          </span>
          
        
      </span>
    </div>
    <div class="article-meta pull-right">
    </div>
  </div>
</div>


  <aside id="sidebar">
    <p id="sidebar-header"></p>
    <ol id="sidebar-toc"></ol>
  </aside>
  <script async>setTimeout(generateToc, 10);</script>


  <nav class="post-navigation">
    
      <div class="nav-pre">
        <i class="iconfont icon-prev"></i>
        ä¸Šä¸€ç¯‡:
        <a href="/passages/redis-3-ex-evict /" target="_self">Redisä»å…¥é—¨åˆ°ç²¾é€š(ä¸‰ã€Redisçš„è¿‡æœŸç­–ç•¥å’Œå†…å­˜æ·˜æ±°æœºåˆ¶)</a>
      </div>
    
    
      <div class="nav-next">
        ä¸‹ä¸€ç¯‡:
        <a href="/passages/redis-5-transaction/" target="_self">Redisä»å…¥é—¨åˆ°ç²¾é€š(äº”ã€Redisçš„äº‹åŠ¡)</a>
        <i class="iconfont icon-next"></i>
      </div>
    
  </nav>

   

   

</div>


      <footer>
  <p class="site-info">
    Copyright Â© Wangkai 2019. All Rights Reserved.
    <br>
    Powered by <a href="https://hexo.io">Hexo</a>  & Theme - <a href="https://github.com/dongyuanxin/theme-bmw">BMW</a>
    <br>
    åšå®¢å·²è¿è¡Œ<span id="time-to-now"></span>
    <br>
    
  </p>
</footer>



<script>
const timeToNowDOM = document.querySelector("#time-to-now");
const startTimestamp = new Date(2019, 3, 14).getTime();

const updateTimeStr = () => {
  let offset = parseInt(
      (new Date().getTime() - startTimestamp) / 1000,
      10
    ),
    day = Math.floor(offset / 86400),
    hour = Math.floor((offset % 86400) / 3600),
    minute = Math.floor(((offset % 86400) % 3600) / 60),
    second = Math.floor(((offset % 86400) % 3600) % 60);
  timeToNowDOM.innerHTML =
    day + "å¤©" + hour + "å°æ—¶" + minute + "åˆ†é’Ÿ" + second + "ç§’";
  setTimeout(updateTimeStr, 500);
}

setTimeout(updateTimeStr, 500);
</script>


      <div class="back-to-top hidden">
  <span>
    <i class="iconfont icon-60"></i><span></span>%
  </span>
</div>

<script>
const updateIconToTop = percent => {
  let dom = document.querySelector(".back-to-top span span");
  dom.innerText = percent;
  if(percent < 1) {
    document.querySelector(".back-to-top").className = "back-to-top hidden";
  } else {
    document.querySelector(".back-to-top").className = "back-to-top";
  }
}

const handleScoll = () => {
  let isRunning = false;
  return () => {
    if (isRunning) return;
    isRunning = true;
    window.requestAnimationFrame(timestamp => {
      let scrollTop =
          document.documentElement.scrollTop || document.body.scrollTop,
        scrollHeight =
          document.documentElement.scrollHeight ||
          document.body.scrollHeight,
        clientHeight =
          document.documentElement.clientHeight ||
          document.body.clientHeight;
      isRunning = false;
      if (scrollTop <= 1) {
        updateIconToTop(0);
        return;
      }
      if (scrollTop + clientHeight >= scrollHeight) {
        updateIconToTop(100);
      } else {
        updateIconToTop(parseInt(
          100 * scrollTop / (scrollHeight - clientHeight),
          10
        ));
      }
    });
  };
}

const backToTop = () => {
  let scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop,
    delay = 10,
    time = 200;
  if (scrollTop <= 20) {
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
    return;
  }
  let step = Math.ceil(scrollTop * delay / time);
  let timer = setInterval(() => {
    scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop;
    if (scrollTop - step <= 0) {
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
      clearInterval(timer);
    } else {
      document.documentElement.scrollTop = scrollTop - step;
      document.body.scrollTop = scrollTop - step;
    }
  }, delay);
}

document.addEventListener("scroll", handleScoll(), false);

document.querySelector(".back-to-top").addEventListener("click", backToTop, false);

</script>

    </div>

    
      <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script>
  (() => {
    const mathjaxConfig = {
      showProcessingMessages: false, //å…³é—­jsåŠ è½½è¿‡ç¨‹ä¿¡æ¯
      messageStyle: "none", //ä¸æ˜¾ç¤ºä¿¡æ¯
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [["$", "$"], ["\\(", "\\)"]], //è¡Œå†…å…¬å¼é€‰æ‹©ç¬¦
        displayMath: [["$$", "$$"], ["\\[", "\\]"]], //æ®µå†…å…¬å¼é€‰æ‹©ç¬¦
        skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"] //é¿å¼€æŸäº›æ ‡ç­¾
      },
      "HTML-CSS": {
        availableFonts: ["STIX", "TeX"], //å¯é€‰å­—ä½“
        showMathMenu: false //å…³é—­å³å‡»èœå•æ˜¾ç¤º
      }
    }

    let mathjaxInterval = setInterval(() => {
      if(!window.MathJax){
        return;
      }
      window.MathJax.Hub.Config(mathjaxConfig)
      window.MathJax.Hub.Queue(["Typeset", MathJax.Hub, document.getElementById('app')])

      clearInterval(mathjaxInterval)
    }, 10)    
  })()
</script>
    

    <script src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script>
<script async>
  let fancyTimer = setInterval(function(){
    if(!window.$){
      return;
    }
    $(document).ready(function() {
      $(".post img").each(function () {
        if($(this).parent().get(0).tagName.toLowerCase() === "a") {
          return;
        }
        // $(this).attr("data-fancybox", "gallery"); // if you add 'data-fancybox', img will display after showed
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "gallery");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      });
      
      clearInterval(fancyTimer);
    });
  }, 10);
</script>

    
  </body>

</html>
